setTitle = () ->
  pending = $('table#pending_estimate tr').size() - 1
  pending = 0 if pending < 0
  if pending > 0
    $(document).prop('title', "(#{pending}) Zenkai")
  else
    $(document).prop('title', "Zenkai")

  $('head link').remove()
  if pending > 9
    $('head').append($('<link rel="icon" type="image/ico" href="pending9+.ico"/>'))
  else
    $('head').append($("<link rel='icon' type='image/ico' href='pending#{pending}.ico'/>"))


$ ->
  $(document).on 'ajax:success', '.best_in_place', ()->
    $table = $(this).closest('table')
    refreshTable $table

  $(document).on 'ajax:success', '.restimate', ()->
    $table = $(this).closest('table')
    refreshTable $table

  refreshTable = ($table) ->
    if $table.data('path')
      $.get $table.data('path'), (data)->
        $table.replaceWith data
        $('.best_in_place').best_in_place()
        setTitle()

  if $('body.dashboard').size() > 0
    setInterval () ->
      refreshTable $('table#pending_estimate')
      refreshTable $('table#pending')
      refreshTable $('table#current')
    , 300000

    setTitle()
  else
    $('head').append($('<link rel="icon" type="image/ico" href="favicon.ico"/>'))

  $(document).on 'keypress', (event) ->
    if event.keyCode == 104
      $('.modal').modal('hide').remove()
      $.get "/sprint_users/new", (data)->
        modal = $(data).modal()
        $(modal).on 'ajax:success', ()->
          $(modal).modal('hide')
